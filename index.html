<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…±æœ‰å®¶è¨ˆç°¿ - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border-radius: 20px;
            font-size: 14px;
            display: none;
        }
        
        .sync-status.syncing {
            background: #f39c12;
            display: block;
        }
        
        .sync-status.error {
            background: #e74c3c;
            display: block;
        }
        
        .card {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-item {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
        }
        
        .income { background: #d4edda; color: #155724; }
        .expense { background: #f8d7da; color: #721c24; }
        .balance { background: #d1ecf1; color: #0c5460; }
        
        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .transaction-item:hover {
            background: #f8f9fa;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .amount {
            font-size: 24px;
            font-weight: bold;
        }
        
        .setup-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
            position: relative;
        }
        
        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 30px;
            cursor: pointer;
        }
        
        @media (max-width: 600px) {
            .container { padding: 10px; }
            .summary { grid-template-columns: 1fr; }
            .modal-content { margin: 20px; }
        }
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus">åŒæœŸä¸­...</div>
    
    <div class="container">
        <header>
            <h1>ğŸ  å…±æœ‰å®¶è¨ˆç°¿</h1>
            <p>å®¶æ—ã¿ã‚“ãªã§ç®¡ç†ã™ã‚‹å®¶è¨ˆç°¿ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆï¼‰</p>
        </header>
        
        <div class="setup-notice" id="setupNotice">
            <strong>ğŸ“Œ åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</strong>
            <p>ã“ã®å®¶è¨ˆç°¿ã¯GitHub Gistã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ã€‚</p>
            <button onclick="showSetupModal()">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹</button>
        </div>
        
        <!-- é›†è¨ˆè¡¨ç¤º -->
        <div class="summary">
            <div class="summary-item income">
                <h3>ä»Šæœˆã®åå…¥</h3>
                <p class="amount" id="totalIncome">Â¥0</p>
            </div>
            <div class="summary-item expense">
                <h3>ä»Šæœˆã®æ”¯å‡º</h3>
                <p class="amount" id="totalExpense">Â¥0</p>
            </div>
            <div class="summary-item balance">
                <h3>æ®‹é«˜</h3>
                <p class="amount" id="balance">Â¥0</p>
            </div>
        </div>
        
        <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="card">
            <h2>åæ”¯ã‚’è¨˜éŒ²</h2>
            <form id="transactionForm">
                <div class="form-group">
                    <label for="date">æ—¥ä»˜</label>
                    <input type="date" id="date" required>
                </div>
                
                <div class="form-group">
                    <label for="type">ç¨®é¡</label>
                    <select id="type" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="income">åå…¥</option>
                        <option value="expense">æ”¯å‡º</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="category">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="category" required>
                        <option value="">ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="amount">é‡‘é¡</label>
                    <input type="number" id="amount" min="1" required placeholder="1000">
                </div>
                
                <div class="form-group">
                    <label for="description">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                    <input type="text" id="description" placeholder="ä¾‹ï¼šã‚¹ãƒ¼ãƒ‘ãƒ¼ã§è²·ã„ç‰©">
                </div>
                
                <button type="submit">è¨˜éŒ²ã™ã‚‹</button>
                <button type="button" class="btn-secondary" onclick="syncData()">ğŸ”„ åŒæœŸ</button>
            </form>
        </div>
        
        <!-- å–å¼•å±¥æ­´ -->
        <div class="card">
            <h2>æœ€è¿‘ã®è¨˜éŒ²</h2>
            <div class="transaction-list" id="transactionList"></div>
        </div>
    </div>
    
    <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="setupModal">
        <div class="modal-content">
            <span class="close" onclick="closeSetupModal()">&times;</span>
            <h2>GitHub Gist ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
            <p>ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ãƒ»å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€GitHub Gistã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            
            <form id="setupForm">
                <div class="form-group">
                    <label for="gistId">Gist ID</label>
                    <input type="text" id="gistId" placeholder="ä¾‹: a1b2c3d4e5f6..." required>
                    <small>æ–°è¦ä½œæˆã®å ´åˆã¯ç©ºæ¬„ã®ã¾ã¾ã€Œä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</small>
                </div>
                
                <div class="form-group">
                    <label for="githubToken">GitHub Personal Access Tokenï¼ˆä»»æ„ï¼‰</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                    <small>æ›¸ãè¾¼ã¿æ¨©é™ãŒå¿…è¦ãªå ´åˆã®ã¿å…¥åŠ›</small>
                </div>
                
                <button type="submit">ä¿å­˜</button>
                <button type="button" class="btn-secondary" onclick="closeSetupModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
            
            <hr style="margin: 20px 0;">
            <p><strong>GitHub Personal Access Tokenã®å–å¾—æ–¹æ³•ï¼š</strong></p>
            <ol>
                <li>GitHubã«ãƒ­ã‚°ã‚¤ãƒ³</li>
                <li>Settings â†’ Developer settings â†’ Personal access tokens</li>
                <li>ã€ŒGenerate new tokenã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>ã€Œgistã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ä½œæˆ</li>
            </ol>
        </div>
    </div>
    
    <script>
        // ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿
        const categories = {
            income: [
                { value: 'salary', label: 'ğŸ’° çµ¦æ–™' },
                { value: 'bonus', label: 'ğŸ ãƒœãƒ¼ãƒŠã‚¹' },
                { value: 'other_income', label: 'ğŸ’µ ãã®ä»–åå…¥' }
            ],
            expense: [
                { value: 'food', label: 'ğŸ½ï¸ é£Ÿè²»' },
                { value: 'daily', label: 'ğŸ§º æ—¥ç”¨å“' },
                { value: 'transport', label: 'ğŸšƒ äº¤é€šè²»' },
                { value: 'entertainment', label: 'ğŸ® å¨¯æ¥½è²»' },
                { value: 'medical', label: 'ğŸ¥ åŒ»ç™‚è²»' },
                { value: 'education', label: 'ğŸ“š æ•™è‚²è²»' },
                { value: 'utilities', label: 'ğŸ’¡ å…‰ç†±è²»' },
                { value: 'rent', label: 'ğŸ  å®¶è³ƒ' },
                { value: 'communication', label: 'ğŸ“± é€šä¿¡è²»' },
                { value: 'other_expense', label: 'ğŸ’¸ ãã®ä»–æ”¯å‡º' }
            ]
        };
        
        let transactions = [];
        let config = {
            gistId: localStorage.getItem('kakeibo_gist_id') || '',
            githubToken: localStorage.getItem('kakeibo_github_token') || ''
        };
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¨­å®šç¢ºèª
            if (!config.gistId) {
                document.getElementById('setupNotice').style.display = 'block';
            } else {
                document.getElementById('setupNotice').style.display = 'none';
                loadFromGist();
            }
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('type').addEventListener('change', updateCategories);
            document.getElementById('transactionForm').addEventListener('submit', addTransaction);
            document.getElementById('setupForm').addEventListener('submit', saveSetup);
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadTransactions();
        });
        
        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showSetupModal() {
            document.getElementById('gistId').value = config.gistId;
            document.getElementById('githubToken').value = config.githubToken;
            document.getElementById('setupModal').style.display = 'block';
        }
        
        function closeSetupModal() {
            document.getElementById('setupModal').style.display = 'none';
        }
        
        function saveSetup(e) {
            e.preventDefault();
            config.gistId = document.getElementById('gistId').value;
            config.githubToken = document.getElementById('githubToken').value;
            
            localStorage.setItem('kakeibo_gist_id', config.gistId);
            localStorage.setItem('kakeibo_github_token', config.githubToken);
            
            closeSetupModal();
            document.getElementById('setupNotice').style.display = 'none';
            
            if (!config.gistId) {
                createNewGist();
            } else {
                loadFromGist();
            }
        }
        
        // GitHub Gistæ“ä½œ
        async function createNewGist() {
            showSyncStatus('syncing', 'æ–°è¦Gistä½œæˆä¸­...');
            
            try {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${config.githubToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: 'å…±æœ‰å®¶è¨ˆç°¿ãƒ‡ãƒ¼ã‚¿',
                        public: false,
                        files: {
                            'kakeibo_data.json': {
                                content: JSON.stringify({ transactions: [] }, null, 2)
                            }
                        }
                    })
                });
                
                if (response.ok) {
                    const gist = await response.json();
                    config.gistId = gist.id;
                    localStorage.setItem('kakeibo_gist_id', config.gistId);
                    showSyncStatus('success', 'Gistä½œæˆå®Œäº†ï¼');
                    alert(`Gist ID: ${gist.id}\nã“ã®IDã‚’å®¶æ—ã¨å…±æœ‰ã—ã¦ãã ã•ã„ã€‚`);
                } else {
                    throw new Error('Gistä½œæˆå¤±æ•—');
                }
            } catch (error) {
                showSyncStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        async function loadFromGist() {
            if (!config.gistId) return;
            
            showSyncStatus('syncing', 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
            
            try {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`);
                
                if (response.ok) {
                    const gist = await response.json();
                    const content = JSON.parse(gist.files['kakeibo_data.json'].content);
                    transactions = content.transactions || [];
                    localStorage.setItem('kakeibo_transactions', JSON.stringify(transactions));
                    loadTransactions();
                    showSyncStatus('success', 'åŒæœŸå®Œäº†');
                } else {
                    throw new Error('Gistèª­ã¿è¾¼ã¿å¤±æ•—');
                }
            } catch (error) {
                showSyncStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                transactions = JSON.parse(localStorage.getItem('kakeibo_transactions') || '[]');
            }
        }
        
        async function saveToGist() {
            if (!config.gistId || !config.githubToken) {
                alert('GitHubè¨­å®šãŒå¿…è¦ã§ã™ã€‚');
                showSetupModal();
                return;
            }
            
            showSyncStatus('syncing', 'ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­...');
            
            try {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${config.githubToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'kakeibo_data.json': {
                                content: JSON.stringify({ 
                                    transactions: transactions,
                                    lastUpdated: new Date().toISOString()
                                }, null, 2)
                            }
                        }
                    })
                });
                
                if (response.ok) {
                    showSyncStatus('success', 'ä¿å­˜å®Œäº†');
                } else {
                    throw new Error('ä¿å­˜å¤±æ•—');
                }
            } catch (error) {
                showSyncStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        function syncData() {
            loadFromGist();
        }
        
        function showSyncStatus(type, message) {
            const status = document.getElementById('syncStatus');
            status.className = 'sync-status ' + type;
            status.textContent = message;
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }
        
        // ã‚«ãƒ†ã‚´ãƒªæ›´æ–°
        function updateCategories() {
            const type = document.getElementById('type').value;
            const categorySelect = document.getElementById('category');
            
            categorySelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            
            if (type && categories[type]) {
                categories[type].forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.value;
                    option.textContent = cat.label;
                    categorySelect.appendChild(option);
                });
            }
        }
        
        // å–å¼•è¿½åŠ 
        async function addTransaction(e) {
            e.preventDefault();
            
            const transaction = {
                id: Date.now(),
                date: document.getElementById('date').value,
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                categoryLabel: document.getElementById('category').selectedOptions[0].textContent,
                amount: parseInt(document.getElementById('amount').value),
                description: document.getElementById('description').value,
                timestamp: new Date().toISOString()
            };
            
            transactions.unshift(transaction);
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
            localStorage.setItem('kakeibo_transactions', JSON.stringify(transactions));
            
            // Gistã«ä¿å­˜
            if (config.gistId && config.githubToken) {
                await saveToGist();
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('transactionForm').reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            document.getElementById('category').innerHTML = '<option value="">ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            // å†èª­ã¿è¾¼ã¿
            loadTransactions();
            
            alert('è¨˜éŒ²ã—ã¾ã—ãŸï¼');
        }
        
        // å–å¼•èª­ã¿è¾¼ã¿
        function loadTransactions() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            let totalIncome = 0;
            let totalExpense = 0;
            
            // ä»Šæœˆã®é›†è¨ˆ
            transactions.forEach(t => {
                if (t.date.startsWith(currentMonth)) {
                    if (t.type === 'income') {
                        totalIncome += t.amount;
                    } else {
                        totalExpense += t.amount;
                    }
                }
            });
            
            // é›†è¨ˆè¡¨ç¤º
            document.getElementById('totalIncome').textContent = 'Â¥' + totalIncome.toLocaleString();
            document.getElementById('totalExpense').textContent = 'Â¥' + totalExpense.toLocaleString();
            document.getElementById('balance').textContent = 'Â¥' + (totalIncome - totalExpense).toLocaleString();
            
            // å–å¼•ãƒªã‚¹ãƒˆè¡¨ç¤º
            const listContainer = document.getElementById('transactionList');
            listContainer.innerHTML = '';
            
            transactions.slice(0, 50).forEach(t => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                item.innerHTML = `
                    <div>
                        <strong>${t.date}</strong>
                        ${t.categoryLabel}
                        ${t.description ? `(${t.description})` : ''}
                    </div>
                    <div>
                        <span style="color: ${t.type === 'income' ? 'green' : 'red'};">
                            ${t.type === 'income' ? '+' : '-'}Â¥${t.amount.toLocaleString()}
                        </span>
                        <button class="delete-btn" onclick="deleteTransaction(${t.id})">å‰Šé™¤</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }
        
        // å–å¼•å‰Šé™¤
        async function deleteTransaction(id) {
            if (confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                transactions = transactions.filter(t => t.id !== id);
                localStorage.setItem('kakeibo_transactions', JSON.stringify(transactions));
                
                if (config.gistId && config.githubToken) {
                    await saveToGist();
                }
                
                loadTransactions();
            }
        }
    </script>
</body>
</html>